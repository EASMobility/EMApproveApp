//endsssvar historyStore;
var prdetailStore;
var worklistStore;
var sessionTokenID;
var userID;
var nameValue ;
var passwordValue ;
var ApprovalComments;
var url;
var bar;
var tabselection;
var DeviceName;
var Platform;
var UniqueID;
var Version;
var buttonfinder;
//added for approve and reject
var activetab;
var mainex;
var mainmask;
var approvedOrNot;

//var reqRequistionNumber;
/////////
var queryvalue = 
{
    "Tid": "123456",
    "SessionTokenId" : localStorage.getItem('sessionToken')
	//"REQUISITIONNUMBER" : "1104046015"
};
var selectedrecord;

var sample="";
Ext.define('eaApprove.controller.Application', {
    extend: 'Ext.app.Controller',
    
    config: {
        refs: {
            main: 'mainview',
            editButton: '#editButton',
			approveButton:'#approveButton',
			approveButton1:'#approveButton1',
			approveButton2:'#approveButton2',
			approveCommentButton:'#approveCommentButton',
			approveCommentButton1:'#approveCommentButton1',
            contacts: '#contactslist',
			contacts1: '#contactslistdue',
			history:'history',
			prdetail:'prdetail',
            showContact: 'contact-show',
			settings: '#toggle',
			showContact: '#listItem',
            editContact: 'contact-edit',
            saveButton: '#saveButton',
			
			
			approve:'approve',
			//added for approve and reject
			approvecomment:'approvecomment',
			rejectButton:'#rejectButton',
			rejectButton1:'#rejectButton1',
			rejectButton2:'#rejectButton2',
			rejectCommentButton:'#rejectCommentButton',
			reject:'reject',
			rejectcomment:'rejectcomment',
			rejectMainButton:'#rejectMainButton',
			
			approveMainButton:'#approveMainButton',
			
			approveDoneButton:'#approveDoneButton',
			rejectDoneButton:'#rejectDoneButton'
			
			///////////////ends
        },
        
        control: {
            main: {
                push: 'onMainPush',
                pop: 'onMainPop'
            },
            editButton: {
                tap: 'onContactEdit'
            },
			
			approveButton: {
                onApproveClick: 'onApproveAction'
            },
			approveButton1: {
                onApproveClick: 'onApproveAction'
            },
			approveButton2: {
                onApproveClick: 'onApproveAction'
            },
			approveCommentButton: {
                onApproveCommentsClick: 'onApproveCommentsAction'
            },
			approveCommentButton1: {
                onApproveCommentsClick: 'onApproveCommentsAction'
            },
			//added for approve and reject
			rejectButton: {
                onRejectClick: 'onRejectAction'
            },
			rejectButton1: {
                onRejectClick: 'onRejectAction'
            },
			rejectButton2: {
                onRejectClick: 'onRejectAction'
            },
			rejectCommentButton: {
                onRejectCommentsClick: 'onRejectCommentsAction'
            },
			rejectMainButton:{
                onRejectMainClick:'onRejectMainACtion'
			},
			approveMainButton:{
                onApproveMainClick:'onApproveMainACtion'
			},
			approveDoneButton:{
                onApproveDoneClick:'onApproveDoneAction'
			},
			rejectDoneButton:{
                onRejectDoneClick:'onRejectDoneAction'
			},
			/////ends
			settings:{
                onmyclick:'loginAuthentication',
                onLogout:'logOut'
			},
            
			showContact:{
                itemtap:'onListItem'
			},
            contacts: {
                itemtap: 'onContactSelect'
            },
			contacts1: {
                itemtap: 'onContactSelect'
            },
            saveButton: {
                tap: 'onContactSave'
            },
            editContact: {
                change: 'onContactChange'
            }
        }
    },
    
	
	
	
	loginAuthentication:function(options)
	{	console.log(options);
        //	alert('how many times' + options);
		mainmask="";
		mainmask=this.getMain();
		var regEmailID = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;
		var urlReg= /^(((http|ftp|https):\/\/)|www\.)[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:/~\+#!]*[\w\-\@?^=%&amp;/~\+#])?/;
		//added for approve and reject
		//alert(localStorage.getItem('username')+'in application');
		if(localStorage.getItem('username') == null){
		
		    if(localStorage.getItem('username')!=Ext.getCmp('username').getValue()){
			
			dropTables();
		    createTables();
		   }
		}
		nameValue = Ext.getCmp('username').getValue();
		localStorage.setItem('username', nameValue);
		passwordValue = Ext.getCmp('password').getValue();
		localStorage.setItem('password', passwordValue);
		url = Ext.getCmp('url').getValue();
		localStorage.setItem('urlValue', url);
		DeviceName = device.name;
        Platform = device.platform;
        UniqueID = device.uuid; 
        Version = device.version;
		//Validation for URL
		if (urlReg.test(url) == false) 
		{
			Ext.getCmp('toggle').setValue(0);
			alert('Please enter a valid URL');
			//loginService(nameValue, passwordValue,url);
			return (false);
		}
		//Validation for Email ID
		else if (regEmailID.test(nameValue) == false) 
		{
			Ext.getCmp('toggle').setValue(0);
			alert('Invalid Email Address');		
			return (false);
		}
		else if((nameValue == "")||(passwordValue == ""))
		{
			Ext.getCmp('toggle').setValue(0);
			alert('Enter a valid username and password');
		}
        
		else
		{
           
			if (check_network() == 'No network connection'||check_network() == 'Unknown connection')
			{
				alert('No network connection');	
			}else{
				//alert('loginservice');
			//loadDatabase();
				loginService(nameValue, passwordValue,url);		
			}
		}
	},
	
 	logOut:function(options)
	{
        localStorage.removeItem('username');
		logOutService(localStorage.getItem('sessionToken'),url);
        //alert('logout');
	},
	
	onApproveAction:function(options){
        
        if (!this.approve) {
            this.approve = Ext.create('eaApprove.view.contact.ReportItems');
        }
		//alert('sdfdfsdf');
		this.getMain().add(this.approve);
		this.approve.show();
        
	},
	
	//added for approve and reject
	onRejectAction:function(options){
        
        if (!this.reject) {
            this.reject = Ext.create('eaApprove.view.contact.ReportItemsReject');
        }
		//alert('sdfdfsdf');
		this.getMain().add(this.reject);
		this.reject.show();
        
	},
    
	
	onRejectMainACtion:function(options){
        
        
		//alert(selectedrecord.data.NOTIFICATIONID);
		
		var _obj={"PRRejectItemReq": 
            {
                "Tid": Math.floor(Math.random()*9000) + 1000,
                "SessionTokenId" : localStorage.getItem('sessionToken'),
                "NOTIFICATIONID" : selectedrecord.data.NOTIFICATIONID,
                "RejectionComments" : ""	
            }
        };
        //console.log(_obj);
        
        rejectRequest(_obj);
        
        
    },
    onRejectDoneAction:function(options){
        
        var RejectionComments=Ext.getCmp('rejectText').getValue();
        //alert(selectedrecord.data.NOTIFICATIONID);
        var _obj={"PRRejectItemReq": 
            {
                "Tid": Math.floor(Math.random()*9000) + 1000,
                "SessionTokenId" : localStorage.getItem('sessionToken'),
                "NOTIFICATIONID" : selectedrecord.data.NOTIFICATIONID,
                "RejectionComments" : RejectionComments	
            }
        };
        //console.log(_obj);
        
        rejectRequest(_obj);
        
        
        
    },											 
    
    onApproveDoneAction:function(options){
        
        ApprovalComments=Ext.getCmp('approveText').getValue();
        //alert(selectedrecord.data.NOTIFICATIONID);
        //alert(selectedrecord.data.NOTIFICATIONID);
        
        if(buttonfinder=="approve"){
            var _obj={"PRApproveItemReq": 
                {
                    "Tid": Math.floor(Math.random()*9000) + 1000,
                    "SessionTokenId" : localStorage.getItem('sessionToken'),
                    "NOTIFICATIONID" : selectedrecord.data.NOTIFICATIONID,
                    "ApprovalComments" : ApprovalComments	
                }
            };
            
            approveRequest(_obj);	 
        }else
        {
            var _obj={"PRRejectItemReq": 
                {
                    "Tid": Math.floor(Math.random()*9000) + 1000,
                    "SessionTokenId" : localStorage.getItem('sessionToken'),
                    "NOTIFICATIONID" : selectedrecord.data.NOTIFICATIONID,
                    "RejectionComments" : ApprovalComments	
                }
            };
            
            rejectRequest(_obj);
            
            
        }			 
        //alert(_obj);
        
        
        
        
        
        
    },									 
    onApproveMainACtion:function(options){
        
        
		
		
		var _obj={"PRApproveItemReq": 
            {
                "Tid": Math.floor(Math.random()*9000) + 1000,
                "SessionTokenId" : localStorage.getItem('sessionToken'),
                "NOTIFICATIONID" : selectedrecord.data.NOTIFICATIONID,
                "ApprovalComments" : ""	
            }
        };
        // console.log(_obj);
        
	    approveRequest(_obj);
        
        
    },
	//endsss								  
	onApproveCommentsAction:function(options){
        //alert("came ");
        if (!this.approveComment) {
            this.approveComment = Ext.create('eaApprove.view.contact.ApproveCmts');
        }
		Ext.getCmp('mainview').getNavigationBar().hide();
		this.getMain().add(this.approveComment);
		this.approveComment.show();
		
		// this.getMain().push(this.approveComment);
        
	},
	
	//added for approve and reject
	onRejectCommentsAction:function(options){
        
        if (!this.rejectComment) {
            this.rejectComment = Ext.create('eaApprove.view.contact.RejectCmts');
        }
		Ext.getCmp('mainview').getNavigationBar().hide();
		this.getMain().add(this.rejectComment);
		this.rejectComment.show();
		
		// this.getMain().push(this.rejectComment);
        
	},
	//ends
	onListItem:function(list, index, node, record){
		
        bar = Ext.getCmp('mainview').getNavigationBar();
        bar.setDefaultBackButtonText('Back');
        console.log('list');
        console.log(selectedrecord.data.REQUISITIONHEADERID);
        console.log(index);
        if(approvedOrNot==false){
        	
		if(index==0){
            //alert('I am Prdeails' );
            
            if (!this.prdetail) {
                this.prdetail = Ext.create('eaApprove.view.contact.Prdetail');
            }
            //alert('Url is' + url);
           if (check_network() == 'No network connection'||check_network() == 'Unknown connection')
				{
        	        alert("network");
					alert('No network connection');	
				}else{
		purchasedetail(url,localStorage.getItem('sessionToken'),selectedrecord.data.REQUISITIONHEADERID)
			
            // Bind the record onto the show Purchase detail view
         
        	  
            record =prdetailStore;
            this.prdetail.setRecord(record);
            
            // Push the show Purchase detail view into the navigation view
            this.getMain().push(this.prdetail);
				}        
		}else if(index==1){
            //alert('I am history screen');
            if (!this.history) {
                this.history = Ext.create('eaApprove.view.contact.History');
            }
            //alert('selectedrecord.data.REQUISITIONNUMBER' + selectedrecord.data.REQUISITIONNUMBER);
            if (check_network() == 'No network connection'||check_network() == 'Unknown connection')
				{
					alert('No network connection');	
				}else{
					
		historydetail(url,localStorage.getItem('sessionToken'),selectedrecord.data.REQUISITIONNUMBER);		
				
            // Bind the record onto the show History view
          
            record = historyStore;
            this.history.setRecord(record);
            
            // Push the show History view into the navigation view
            //this.getMain().query('#navBar')[0].titleComponent.setWidth(100);
            this.getMain().push(this.history);
				}	      
		}
	}
	},
    onMainPush: function(view, item) {
        //alert('HI');
        var editButton = this.getEditButton();
        
        if (item.xtype == "contacts") {
            this.showEditButton();
        } else {
            //alert('hi.....');
            this.hideEditButton();
        }
    },
	/*   onMainPop: function(view, item) {
     alert('hi pop' + item.xtype);
     if (item.xtype == "contact-show") {
     alert('hi pop');
     this.showEditButton();
     } else {
     this.hideEditButton();
     }
     }, */
    
    
    
    onContactSelect: function(list, index, node, record) {
	    //alert("came inside");
		selectedrecord=record;
		approvedOrNot=false;
		mainex="";
		mainex=this.getMain();
		mainmask="";
		mainmask=this.getMain();
		url=Ext.getCmp('url').getValue();
		
        var editButton = this.getEditButton();
        
        if (!this.showContact) {
            this.showContact = Ext.create('eaApprove.view.contact.Show');
        }
        
        // Bind the record onto the show contact view
        this.showContact.setRecord(record);
        
        // Push the show contact view into the navigation view
        this.getMain().push(this.showContact);
    },
    
    onContactEdit: function() {
        if (!this.editContact) {
            this.editContact = Ext.create('eaApprove.view.contact.Edit');
        }
        
        // Bind the record onto the edit contact view
        this.editContact.setRecord(this.getShowContact().getRecord());
        
        this.getMain().push(this.editContact);
    },
    
    onContactChange: function() {
        this.showSaveButton();
    },
    
    onContactSave: function() {
        var record = this.getEditContact().saveRecord();
        
        this.getShowContact().updateRecord(record);
        
        this.getMain().pop();
    },
    
    showEditButton: function() {
        var editButton = this.getEditButton();
        editButton.show();
        
    },
    
    hideEditButton: function() {
        var editButton = this.getEditButton();
		editButton.hide();
        
    },
    
    showSaveButton: function() {
        var saveButton = this.getSaveButton();
        
        if (!saveButton.isHidden()) {
            return;
        }
        
        saveButton.show();
    },
    
    hideSaveButton: function() {
        var saveButton = this.getSaveButton();
        
        if (saveButton.isHidden()) {
            return;
        }
        
        saveButton.hide();
    },
	
	init: function() {
        
        //  var main = Ext.getCmp('mainview').getNavigationBar();
        
        
        
        //main.getNavigationBar().setDefaultBackButtonText(null);
        //  main.getNavigationBar().setTitle(this.appTitle);
		
    },
	
	launch: function () {
	    //showEditButton();  
		worklistStore = Ext.getStore("Worklists");
		worklistStore.load();
        historyStore = Ext.getStore("Historys");
        historyStore.load();
		prdetailStore = Ext.getStore("Prdetails");
        prdetailStore.load();
        
        
    }
    
    
});

function loginService(username,password,url){
    //alert(username);
    //alert(url);
    //alert(password);
	//worklistrequest(url,'Abcd12345');
	mainmask.mask({ xtype: 'loadmask',message:'' });
	var ajax = new XMLHttpRequest();
	var _object = {
		username : username,
		password: password
		
	};
	
	var obj=
    {
        "Tid": Math.floor(Math.random()*9000) + 1000,
        
        "username": username,
        "password": password,
        "SessionTokenId" : "",        
        "DeviceInfo":
        {
            "DeviceName": DeviceName,
            "DeviceVersion": Version,
            "UniqueDeviceID": UniqueID, 
            "Platform" : Platform       
            
        }
    };
	
	var object = {
        AuthenticateUserReq:obj,
	};
	
	ajax.open('POST',url, true);
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(object));
	//alert(JSON.stringify(object));
	
	ajax.onreadystatechange = function() {
		//alert(ajax.status);
		_oonreadystatechange(ajax);
		
	}
	
	var _oonreadystatechange = function(ajax, optss) {
		//console.log(ajax.status);
		//alert(ajax.readyState);
		if (ajax.readyState == '4') {
		//alert(ajax.status);
			if (ajax.status == '200') {
			   
				
                var data = JSON.parse(ajax.responseText);
                //alert(data);
				
                if(data.AuthenticateUserRes.Status.Code=='200')
                {
                    sessionTokenID = data.AuthenticateUserRes.SessionTokenId;
                    localStorage.setItem('sessionToken', sessionTokenID);
                    userID = data.AuthenticateUserRes.USERID;
                    
                    localStorage.setItem('userid', userID);
                    //	alert(localStorage.getItem('userid'));
                    //alert(localStorage.getItem('sessionToken'));
                   if (check_network() == 'No network connection'||check_network() == 'Unknown connection')
			{
				alert('No network connection');	
			}else{
			worklistrequest(url,localStorage.getItem('sessionToken'));		
			WorklistDetailsReqProcess(url,localStorage.getItem('sessionToken'))	;
			
			}	
				}
				else if(data.AuthenticateUserRes.Status.Code=='402')  //Invalid user
				{
					alert('Invalid username or password. Try again');
					
				}
				else if(data.AuthenticateUserRes.Status.Code=='401')  //Invaid Session due to session timeout
				{
					loginService(nameValue, passwordValue,url);
					
				}
                mainmask.unmask();
			}  
			else if(ajax.status == '502'){
				alert("Unable to connect");
				Ext.getCmp('toggle').setValue(0);
				mainmask.unmask();
				
				
				} 
                else if(ajax.status == '0'){
				alert("Unable to connect");
				Ext.getCmp('toggle').setValue(0);
				mainmask.unmask();
				
				
				} 				
		}
	};
}

function logOutService(sessionToken,url){
	//url ='http://10.232.155.69:8888/ea-erp';
	url = Ext.getCmp('url').getValue();
	var ajax = new XMLHttpRequest();
	var _object = {
        "Tid": Math.floor(Math.random()*9000) + 1000,
        
        "SessionTokenId" : sessionToken,    
	};
    
	var object = {
        LogoutUserReq:_object,
	};
	
	ajax.open('POST',url, true);
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(object));
	//alert(JSON.stringify(object));
	ajax.onreadystatechange = function() {
		//alert(ajax.status);
		_oonreadystatechange(ajax);
		
	}
	var _oonreadystatechange = function(ajax, optss) {
		//console.log(ajax.status);
		if (ajax.readyState == '4') {
			if (ajax.status == '200') {
                var data = JSON.parse(ajax.responseText);
                //alert(data);
                if(data.LogoutUserRes.Status.Code=='200')
                {
                    //sessionTokenID = data.AuthenticateUserRes.SessionTokenId;
                    //alert('logout-before delete' + localStorage.getItem('userid'));
                    worklistStore.removeAll();
                    localStorage.setItem('sessionToken', '');
                    localStorage.setItem('userid', '');
                    //alert('USER SUCCESSFULLY LOGGED OUT ' + localStorage.getItem('userid'));
				}
				
			} 
		}
	};
}




//Code for Worklist Details
function WorklistDetailsReqProcess(url,sessionTokenID)
{
	//alert('WorklistDetailsReqProcess Called');
	url = Ext.getCmp('url').getValue();
	var ajax = new XMLHttpRequest();
	var _object = {
        "Tid": Math.floor(Math.random()*9000) + 1000,
        
        "SessionTokenId" : sessionTokenID,
        "PRSupport" : "1",
        "POSupport": "0",
        "ExpenseSupport" : "0",
        "TradePromotionsupport" : "0"	
	};
	
	var object = {
        WorkListDetailsReq:_object,
	};
    
	ajax.open('POST',url, true); //Kawal change
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(object));
	ajax.onreadystatechange = function() {
		_oonreadystatechange(ajax);
	}
	var _oonreadystatechange = function(ajax, optss) {
		console.log(ajax.status);
		if (ajax.readyState == '4') 
		{
			if (ajax.status == '200') 
			{
				var data = JSON.parse(ajax.responseText);
                //	alert(data);
				if(data.WorkListDetailsRes.Status.Code=='200')
				{			
					//alert('Success in storing worklist details');					
				}
			} 
		}
	};
}

//added for approve and reject
function autorefresh()
{
	setTimeout(function(){worklistrequest(Ext.getCmp('url').getValue(),localStorage.getItem('sessionToken'))},600000);
}
//ends

function worklistrequest(url,sessionTokenID)
{
    //alert(sessionTokenID);
    // alert(url);
    url = Ext.getCmp('url').getValue();
	var ajax = new XMLHttpRequest();
	var _object = {
        "Tid": Math.floor(Math.random()*9000) + 1000,
        
		"SessionTokenId" :sessionTokenID
    };
	
	var object = {
        QueryWorklistPRReq:_object
	};
	
	//ajax.open('POST', 'http://127.0.0.1:8888/ea-erp', true);
	ajax.open('POST',url, true); //Kawal change
	//ajax.open('POST','respose.json', true);
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(object));
	//alert(JSON.stringify(object));
	ajax.onreadystatechange = function() 
	{
		_oonreadystatechange(ajax);
	}
	var _oonreadystatechange = function(ajax, optss) 
	{		
		if (ajax.readyState == '4') {
			if (ajax.status == '200') 
			{
				var data = JSON.parse(ajax.responseText);
				if(data.QueryWorklistPRApprRes.Status.Code==='200')
				{		
					//console.log(data);
					for ( var i = 0; i < data.QueryWorklistPRApprRes.PurchaseRequisition.length; i++) 
					{						
						//console.log(data.QueryWorklistPRApprRes.PurchaseRequisition[i].REQUISITIONNUMBER);
						insertWorklist(
						data.QueryWorklistPRApprRes.Tid,//added for approve and reject
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].REQUISITIONHEADERID,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].REQUESTOR,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].NOTIFICATIONID,//added for approve and reject
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].DESCRIPTION,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].APPROVALREQUESTEDDATE,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].Amount,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].MESSAGENAME,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].APPROVALREQUESTEDBY,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].APPROVEREMPLOYEENUMBER,
						data.QueryWorklistPRApprRes.PurchaseRequisition[i].REQUISITIONNUMBER);		
						/*worklistStore.add({
                         REQUISITIONNUMBER : data.QueryWorklistPRApprRes.PurchaseRequisition[i].REQUISITIONNUMBER
                         });*/
					}					
                    autorefresh();//added for auto refresh
				}
			    //reqheaderID = localStorage.setItemK('requestheaderid',
                else if(data.QueryWorklistPRApprRes.Status.Code=='401')  //Invaid Session due to session timeout
				{
					loginService(nameValue, passwordValue,url);	
					
				}
				mainmask.unmask();
			} 
		}
	};
}

function historydetail(url,sessionTokenID,requestRequistionNumber)
{
	var ajax = new XMLHttpRequest();
	url = Ext.getCmp('url').getValue();
	//alert(requestRequistionNumber);
	var _object = {
        "Tid": Math.floor(Math.random()*9000) + 1000,
        
		"SessionTokenId" :sessionTokenID,
		"REQUISITIONNUMBER" : requestRequistionNumber //"REQUISITIONNUMBER" : "1104048413"  for user ID 128557  //"REQUISITIONNUMBER" : "1104046994" for UserID 116401    //"REQUISITIONNUMBER": "1104046932" for user ID 104857
    };
	
	var object = {
        QueryHistoryItemsReq:_object
	};
	//alert("url is " + url);
	//alert(url);
	ajax.open('POST',url, true);
	//ajax.open('POST','history.json', true);
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(object));
	//alert(JSON.stringify(object));
	ajax.onreadystatechange = function() {
		_oonreadystatechange(ajax);
	}
	mainmask.mask({ xtype: 'loadmask',message:'' });
	var _oonreadystatechange = function(ajax, optss) 
	{	
		historyStore.removeAll();
		 Ext.getCmp('rejectButton2').setDisabled(true);
           Ext.getCmp('approveButton2').setDisabled(true);
			 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
		
		    button1[0].disable();
		if (ajax.readyState == 4) 
		{
			
			if (ajax.status == 200) 
			{
				var data = JSON.parse(ajax.responseText);
				console.log(data);
				
				
				 Ext.getCmp('rejectButton2').setDisabled(false);
   	            Ext.getCmp('approveButton2').setDisabled(false);
				 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
			
			button1[0].enable();
				if(data.QueryPRHistoryRes.Status.Code==='200')
				{
				    
                    if(data.QueryPRHistoryRes.PurchaseRequisition.length===0)
                    {
                        Ext.getCmp('historylist').show();
                        Ext.getCmp('historylist').setTitle('No History items');
                        Ext.getCmp('historytoolbar').hide();
                        
					}
					else
					{
                        Ext.getCmp('historylist').setTitle('');
                        Ext.getCmp('historytoolbar').show();
					}
                    
					for ( var i = 0; i < data.QueryPRHistoryRes.PurchaseRequisition.length; i++) 
					{				
                        
						historyStore.add(
						{
							REQUISITIONHEADERID:data.QueryPRHistoryRes.PurchaseRequisition[i].REQUISITIONHEADERID,
							REQUESTOR: data.QueryPRHistoryRes.PurchaseRequisition[i].REQUESTOR,
							APPROVEREMPLOYEENUMBER: data.QueryPRHistoryRes.PurchaseRequisition[i].APPROVEREMPLOYEENUMBER,
							DESCRIPTION:commentellipses(data.QueryPRHistoryRes.PurchaseRequisition[i].DESCRIPTION),
							APPROVALREQUESTEDDATE:formatteddatefunction(data.QueryPRHistoryRes.PurchaseRequisition[i].APPROVALREQUESTEDDATE),
							Amount:data.QueryPRHistoryRes.PurchaseRequisition[i].Amount,
							MESSAGENAME:data.QueryPRHistoryRes.PurchaseRequisition[i].MESSAGENAME,
							APPROVALREQUESTEDBY:data.QueryPRHistoryRes.PurchaseRequisition[i].APPROVALREQUESTEDBY,
							APPROVEDDATE:formatteddatefunction(data.QueryPRHistoryRes.PurchaseRequisition[i].APPROVEDDATE),
							TOUSER:data.QueryPRHistoryRes.PurchaseRequisition[i].TOUSER,
						});
					}
					
				}				
				else if(data.QueryPRHistoryRes.Status.Code=='401')  //Invaid Session due to session timeout
				{
					if (check_network() == 'No network connection'||check_network() == 'Unknown connection')
					{
						alert('No network connection');	
					}else{
					loginService(nameValue, passwordValue,url);
					historydetail(url,localStorage.getItem('sessionToken'),selectedrecord.data.REQUISITIONNUMBER);
					}	
					
				}	
				mainmask.unmask();
			} 
			else if(ajax.status == '502'){
				alert("Unable to connect");
				 Ext.getCmp('rejectButton2').setDisabled(true);
   	            Ext.getCmp('approveButton2').setDisabled(true);
				 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
			
			    button1[0].enable();
				mainmask.unmask();
				
				
				}  else if(ajax.status == '0'){
				alert("Unable to connect");
				 Ext.getCmp('rejectButton2').setDisabled(true);
   	            Ext.getCmp('approveButton2').setDisabled(true);
				 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
			
			    button1[0].enable();
				mainmask.unmask();
				
				
				} 	
				else if(ajax.status == '404'){
					alert("Unable to connect");
					 Ext.getCmp('rejectButton2').setDisabled(true);
	   	            Ext.getCmp('approveButton2').setDisabled(true);
					 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
				
				    button1[0].enable();
					mainmask.unmask();
					
					
					} 	
				else if(ajax.status == '500'){
					alert("Unable to connect");
					 Ext.getCmp('rejectButton2').setDisabled(true);
	   	            Ext.getCmp('approveButton2').setDisabled(true);
					 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
				
				    button1[0].enable();
					mainmask.unmask();
					
					
					} 	
		} 
	};
}


function purchasedetail(url,sessionTokenID,requestheaderID){
    
    //alert ('url is ' + url) ;
    url = Ext.getCmp('url').getValue();
	var ajax = new XMLHttpRequest();
	var _object = {
        "Tid": Math.floor(Math.random()*9000) + 1000,
        
		"SessionTokenId" : sessionTokenID,
		"REQUISITIONHEADERID": requestheaderID //user ID 128557  //"REQUISITIONHEADERID": "266138" for user 143593      //"REQUISITIONHEADERID": "266079" for user 136772		
	};
	
	
	var object = {
        QueryPRDetailedInfoReq:_object
	};
	
	//ajax.open('POST', 'respose.json', true);
	ajax.open('POST',url, true); //Kawal change
	//ajax.open('POST','prdetail.json', true); 
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(object));
	//alert(JSON.stringify(object));
	ajax.onreadystatechange = function() {
		_oonreadystatechange(ajax);
	}
	mainmask.mask({ xtype: 'loadmask',message:'' });
	var _oonreadystatechange = function(ajax, optss) {
        //alert(ajax.status);
		 prdetailStore.removeAll();
		 Ext.getCmp('rejectButton1').setDisabled(true);
            Ext.getCmp('approveButton1').setDisabled(true);
			 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
		    button1[0].disable();
		if (ajax.readyState == 4) {
			
			if (ajax.status == 200) {
                //alert('I am success');
                //alert(data.QueryPRDetailedInfoRes.PRDetailedInfo);
				 Ext.getCmp('rejectButton1').setDisabled(false);
   	            Ext.getCmp('approveButton1').setDisabled(false);
				 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
			    button1[0].enable();
                var data = JSON.parse(ajax.responseText);
                //console.log(data);
				
                if(data.QueryPRDetailedInfoRes.Status.Code==='200')
                {
                   
                    //var PRDetailedInfoRes = JSON.stringify(data.QueryPRDetailedInfoRes);
                    //alert(PRDetailedInfoRes);			
                    for ( var i = 0; i < data.QueryPRDetailedInfoRes.PRDetailedInfo.length; i++) 
                    {				
                        var unit=data.QueryPRDetailedInfoRes.PRDetailedInfo[i].UNITPRICE;
                        
                        var unitprice;
                        
                        if(unit.indexOf('.')==-1){
                            
                            unitprice=parseFloat(data.QueryPRDetailedInfoRes.PRDetailedInfo[i].UNITPRICE).toFixed(2);
                        }	else
                        {
                            unitprice=parseFloat(data.QueryPRDetailedInfoRes.PRDetailedInfo[i].UNITPRICE);  
                        }		
                        
                        prdetailStore.add(
                        {				
                            REQUISITIONHEADERID:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].REQUISITIONHEADERID,
                            FROMUSER: data.QueryPRDetailedInfoRes.PRDetailedInfo[i].FROMUSER,
                            ITEMDESCRIPTION:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].DESCRIPTION,
                            LINETYPE:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].LINETYPE,
                            UNITPRICE:unitprice,
                            LASTUPDATEDATE:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].LASTUPDATEDATE,
                            QUANTITY:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].QUANTITY,
                            LASTUPDATELOGIN:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].LASTUPDATELOGIN,
                            REQUESTOR:data.QueryPRDetailedInfoRes.PRDetailedInfo[i].REQUESTOR
                        });
                    }
                  
                }else if(data.QueryPRHistoryRes.Status.Code=='401')  //Invaid Session due to session timeout
				{
					if (check_network() == 'No network connection'||check_network() == 'Unknown connection')
					{
						alert('No network connection');	
					}else{
					loginService(nameValue, passwordValue,url);
					purchasedetail(url,localStorage.getItem('sessionToken'),selectedrecord.data.REQUISITIONHEADERID)
					}	
					
				}	
                mainmask.unmask();
			}  
			else if(ajax.status == '502'){
				alert("Unable to connect");
				 Ext.getCmp('rejectButton1').setDisabled(true);
   	            Ext.getCmp('approveButton1').setDisabled(true);
				 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
			    button1[0].enable();
				mainmask.unmask();
				
				
				}  else if(ajax.status == '0'){
				alert("Unable to connect");
				 Ext.getCmp('rejectButton1').setDisabled(true);
   	            Ext.getCmp('approveButton1').setDisabled(true);
				 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
			    button1[0].enable();
				mainmask.unmask();
				
				
				} 	
				else if(ajax.status == '404'){
					alert("Unable to connect");
					 Ext.getCmp('rejectButton1').setDisabled(true);
	   	            Ext.getCmp('approveButton1').setDisabled(true);
					 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
				    button1[0].enable();
					mainmask.unmask();
					
					
					}
				else if(ajax.status == '500'){
					alert("Unable to connect");
					 Ext.getCmp('rejectButton1').setDisabled(true);
	   	            Ext.getCmp('approveButton1').setDisabled(true);
					 var button1 = Ext.getCmp('mainview').getNavigationBar().query('button');
				    button1[0].enable();
					mainmask.unmask();
					
					
					}
		}
	};
}

//added for approve and reject
function rejectRequest(obj){
    
    url = Ext.getCmp('url').getValue();
    
	var ajax = new XMLHttpRequest();
	ajax.open('POST', url, true);
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(obj));
	//alert(JSON.stringify(obj));
	ajax.onreadystatechange = function() {
		_oonreadystatechange(ajax);
	}
	mainmask.mask({ xtype: 'loadmask',message:'' });
	var _oonreadystatechange = function(ajax, optss) {
		
		if (ajax.readyState == '4') {
			if (ajax.status == '200') {
                var data = JSON.parse(ajax.responseText);
                if(data.PRRejectItemRes.Status.Code=='200')
                {
                    
                    console.log(data.NOTIFICATIONID);
                    console.log(data)
					
                    EmApprove
                    .transaction(function(transaction) {
                        transaction
						.executeSql(
                        "DELETE FROM worklist where NOTIFICATIONID=?",[data.NOTIFICATIONID],
                        function(transaction, results) {console.log(results);
                            worklistrequest_database(activetab);
                            //worklistrequest_database_category();
                            
                            approvedOrNot=true;
                            mainex.pop();
                        },function(transaction, error) {
                            console.log(error.message);
                            
                        });
                    });
                    
                    
                }
                else
                {
                    alert(data.PRRejectItemRes.Status.Text);
                   
                }
                mainmask.unmask();
			}  
			else if(ajax.status == '502'){
				alert("Unable to connect");
				
				mainmask.unmask();
				
				
				}  else if(ajax.status == '0'){
				alert("Unable to connect");
			
				mainmask.unmask();
				
				
				} 
				else if(ajax.status == '404'){
					alert("Unable to connect");
				
					mainmask.unmask();
					
					
					} 	
				else if(ajax.status == '500'){
					alert("Unable to connect");
				
					mainmask.unmask();
					
					
					} 	
		}
	};
}

function approveRequest(obj){
    //alert(obj);
    //approvedOrNot=true;
    url = Ext.getCmp('url').getValue();
    
	var ajax = new XMLHttpRequest();
	ajax.open('POST', url , true);
	ajax.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
	ajax.setRequestHeader('Access-Control-Allow-Origin', '*');
	ajax.send(JSON.stringify(obj));
	
	ajax.onreadystatechange = function() {
		_oonreadystatechange(ajax);
	}
	mainmask.mask({ xtype: 'loadmask',message:'' });
	var _oonreadystatechange = function(ajax, optss) {
		
		if (ajax.readyState == '4') {
			if (ajax.status == '200') {
                var data = JSON.parse(ajax.responseText);
                console.log(data.NOTIFICATIONID);
				console.log(data)
				
                if(data.PRApproveItemRes.Status.Code=='200')
                {
                    
                    console.log(data.NOTIFICATIONID);
                    console.log(data)
                    EmApprove
                    .transaction(function(transaction) {
                        transaction
						.executeSql(
                        "DELETE FROM worklist where NOTIFICATIONID=?",[data.NOTIFICATIONID],
                        function(transaction, results) {console.log(results);
                            worklistrequest_database(activetab);
                            //worklistrequest_database_category();
                            approvedOrNot=true;
                            mainex.pop();
                        },function(transaction, error) {
                            console.log(error.message);
                            
                        });
                    });
                    
                   
                }
                else
                {
                    alert(data.PRApproveItemRes.Status.Text);
                   
                }
				 mainmask.unmask();
			}  
			else if(ajax.status == '502'){
				alert("Unable to connect");
				
				mainmask.unmask();
				
				
				}  else if(ajax.status == '0'){
				alert("Unable to connect");
				
				mainmask.unmask();
				
				
				} 
				else if(ajax.status == '404'){
					alert("Unable to connect");
				
					mainmask.unmask();
					
					
					} 	
				else if(ajax.status == '500'){
					alert("Unable to connect");
				
					mainmask.unmask();
					
					
					} 
		}
	};
}


function worklistrequest_database(string) {
    //alert(string);
    var ApproverEmployeeNumber = localStorage.getItem('userid');
    var queryString;
    if(string === 'Start Date')
    queryString = 'APPROVALREQUESTEDDATE';
    else
    queryString = 'APPROVALREQUESTEDBY';
	EmApprove
    .transaction(function(transaction) {
        transaction
        .executeSql(
        // "SELECT * FROM worklist where APPROVEREMPLOYEENUMBER = " + ApproverEmployeeNumber + " order by    substr("+queryString+",7) ||substr("+queryString+",4,2)||substr("+queryString+",1,2)"+ " desc;",
        "SELECT * FROM worklist where APPROVEREMPLOYEENUMBER = " + ApproverEmployeeNumber+";" ,	
        
        [],
        
        function(transaction, results) {
            worklistStore.removeAll();
            if (results.rows.length != 0) {
                var rows =[];
                var row=null;
                //worklistStore.removeAll();
                for ( var i = 0; i < results.rows.length; i++) {
                    row = results.rows.item(i);
                    
                    rows.push({
                        "APPROVALREQUESTEDDATE_sort": new Date(results.rows.item(i).APPROVALREQUESTEDDATE),
                        
                        "APPROVALREQUESTEDBY_sort": new Date(results.rows.item(i).APPROVALREQUESTEDBY),
                        
                        
                        "REQUISITIONHEADERID":results.rows.item(i)['REQUISITIONHEADERID'],
                        "FROMUSER": results.rows.item(i)['FROMUSER'],
                        "NOTIFICATIONID":results.rows.item(i)['NOTIFICATIONID'],
                        "DESCRIPTION":commentellipses(results.rows.item(i)['DESCRIPTION']),
                        "Amount":results.rows.item(i)['Amount'],
                        "APPROVALREQUESTEDDATE":results.rows.item(i)['APPROVALREQUESTEDDATE'],
                        "MESSAGENAME":results.rows.item(i)['MESSAGENAME'],
                        "APPROVALREQUESTEDBY":results.rows.item(i)['APPROVALREQUESTEDBY'],
                        "APPROVEREMPLOYEENUMBER":results.rows.item(i)['APPROVEREMPLOYEENUMBER'],
                        "REQUISITIONNUMBER":results.rows.item(i)['REQUISITIONNUMBER'],
                        "FULLAPPROVALREQUESTEDDATE":formatteddatefunction(results.rows.item(i)['APPROVALREQUESTEDDATE']),
                        "FULLAPPROVALREQUESTEDBY":formatteddatefunction(results.rows.item(i)['APPROVALREQUESTEDBY']),
                        
                        
                        
                    });
                }
                rows.sort(function (a, b) {
                    if(string === 'Start Date'){
                        var ascending = b.APPROVALREQUESTEDDATE_sort.getTime() - a.APPROVALREQUESTEDDATE_sort.getTime();
                        // descending = b.APPROVALREQUESTEDDATE_sort.getTime() - a.APPROVALREQUESTEDDATE_sort.getTime();
                    }else{
                        var ascending = b.APPROVALREQUESTEDBY_sort.getTime() - a.APPROVALREQUESTEDBY_sort.getTime();
                        // descending = b.APPROVALREQUESTEDBY_sort.getTime() - a.APPROVALREQUESTEDBY_sort.getTime();
                    }
                    return ascending;
                });
                
                for ( var i = 0; i < rows.length; i++) {
                    row = rows[i];
                    //console.log('I am at DB model ' +row['APPROVALREQUESTEDDATE']);
                    //console.log(formatteddatefunction(row['APPROVALREQUESTEDDATE']));
                    
                    worklistStore
                    .add({
                        TID:row['TID'],
                        REQUISITIONHEADERID:row['REQUISITIONHEADERID'],
                        FROMUSER: row['FROMUSER'],
                        NOTIFICATIONID:row['NOTIFICATIONID'],
                        DESCRIPTION:commentellipses(row['DESCRIPTION']),
                        Amount:row['Amount'],
                        APPROVALREQUESTEDDATE:worklistdatefunction(row['APPROVALREQUESTEDDATE']),
                        MESSAGENAME:row['MESSAGENAME'],
                        APPROVALREQUESTEDBY:worklistdatefunction(row['APPROVALREQUESTEDBY']),
                        APPROVEREMPLOYEENUMBER:row['APPROVEREMPLOYEENUMBER'],
                        REQUISITIONNUMBER:row['REQUISITIONNUMBER'],
                        FULLAPPROVALREQUESTEDDATE:formatteddatefunction(row['APPROVALREQUESTEDDATE']),
                        FULLAPPROVALREQUESTEDBY:formatteddatefunction(row['APPROVALREQUESTEDBY']),
                    });
                }
                
            }
            console.log(worklistStore.getCount());	
            if(worklistStore.getCount()==0){
                
                alert('No work list items');
                
            }else{
                
            }
            autorefresh();
        }, function(transaction, error) {
            console.log(error.message);
            
        });
    });
    //checkTables();
}



function formatteddatefunction(dates){
    var datearray=[];
    datearray=dates.split(" ");
    var formatteddate=datearray[1]+" "+datearray[2]+", "+datearray[3];	
    console.log(formatteddate);	
    return formatteddate;
    
    
}	

function worklistdatefunction(dates){
    var datearray=[];
    //alert("workklist");
    datearray=dates.split(" ");
    var formatteddate=datearray[1]+" "+datearray[2];	
    console.log(formatteddate);	
    return formatteddate;
    
    
}	

function checkTables(){
    EmApprove
    .transaction(function(transaction) {
        transaction
        .executeSql(
        "SELECT * FROM worklist ;",
        [],
        function(transaction, results) {
            
            if(results.rows.length!=0){
                tabselection=true;
                console.log(tabselection);
                Ext.getCmp('mytabsview').setActiveItem(0);
                
                
            }
            else
            {
                
                bar = Ext.getCmp('mainview').getNavigationBar();
                bar.titleComponent.setTitle("Settings");
                
            }
            
        },
        function(transaction, error) {
            console.log(error.message);
            
        });
    });
    
}

function commentellipses(comments)
{
   
    if(comments.length>40)
    {
               
        var str1=comments.substring(0,40)+"...";
        return str1;
    }
    else
    {
        return comments;
    }
}

//endsss